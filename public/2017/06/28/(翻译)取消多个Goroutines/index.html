<html>

<head>
    <title>(翻译)取消多个Goroutines</title>
</head>

<body>
    <div>(翻译)取消多个Goroutines</div>
    <div>2017-06-28 13:06:04</div>
    <div><p>原文 <a href="https://chilts.org/2017/06/12/cancelling-multiple-goroutines">https://chilts.org/2017/06/12/cancelling-multiple-goroutines</a></p>

<h1>Cancelling Multiple Goroutines 取消多协程</h1>

<p>When Go was first released, there was a way to do some things in concurrency. As time has gone on, various things have changed. The Context package for one thing. :)</p>

<p>在Go刚开始发行的时候，只有一种并发的方法。随着时间流逝，很多事情都发生了变化。Context包就是其中之一。</p>

<p>This article doesn’t go into all of the ways of doing concurrency but will focus on one problem and take you through a few different solutions so you can see how things have evolved.</p>

<p>这篇文章不会探究所有并发的方法，但是会研究一个问题，并带你熟悉一些不同的解决方法，让你了解方法是如何推论出来的。</p>

<h2>The Problem</h2>

<p>The problem I’d like to address here is being able to cancel multiple goroutines. There are many blog posts out there (I curate @CuratedGo, please follow) which show how to cancel just one goroutine, but my use-case was slightly more complicated. The rest of this article summarises my progress through getting this to work.</p>

<p>我在这里想提出的问题是取消对协程。有许多blog写了如何取消一个协程，但是我的用例是更加复杂的。下面的文章总结了我实现的过程。</p>

<p>The way we’re going decide when to quit is by listening for a C-c keypress. Of course at that point, we want to make sure we tidy up things nicely at that point. For example, if we’re currently streaming tweets from Twitter, we’d rather we told them we’re finished than just drop the connection.</p>

<p>我们要决定何时退出的方式是监听C-c按键。当然，我们确保我们在这一点上很好地处理事情。例如，如果我们目前正在推送Twitter的推文，我们要告诉他们我们已经完成，而不是放弃了解。</p>

<p>Let’s get started.
让我们开始吧</p>

<h2>A Main without Tidying up</h2>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>And let’s run it and C-c it.</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">01</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213112.045887655</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213115.045986150</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213118.045993591</span>
<span class="pun">^</span><span class="typ">Csignal</span><span class="pun">:</span> <span class="pln">interrupt</span>
</pre>

<p>Here you can see we have sent the interrupt signal. Make a mental note of that name. However, we haven’t actually tidied up the timer. There are a few ways we could do it, and the easiest for this program is to defer ticker.Stop() so it gets run at the end of main().</p>

<p>在这里你可以看到，我们发送了中断信号。在心里记住这个名字。但是我们还没有正确的整理好定时器。有许多方法可以做到，其中最简单的是defer tick.Stop(),他在main()的结尾运行。</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

</pre>

<p>There is no discernable difference in the output, however you are being a good citizen. :)</p>

<p>在输出的结果中并没有明显的区别，但是你现在是一个良好市民.:)</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">02</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213456.385205269</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213459.385180852</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213502.385222563</span>
<span class="pun">^</span><span class="typ">Csignal</span><span class="pun">:</span> <span class="pln">interrupt</span>
</pre>

<p>We said earlier that we want to run multiple goroutines and we want to listen for C-c, so let’s do the C-c first.
我们之前说过，我们想运行多协程并且我们想监听C-c，所以我们先完成C-c。</p>

<p>Using the os/signal package, we can tell Go to listen for (you guessed itirst.
我们之前说过，我们想运行多协程并且我们想监听C-c，所以我们先完成C-c。</p>

<p>Using the os/signal package, we can tell Go to listen for (you guessed it) OS Signals such as os.Interrupt and os.Kill. Let’s see what that looks like:</p>

<p>使用 os/signal包，我们可以告诉Go监听操作系统的信号，例如os.Interrupt和os.Kill。让我们看一下吧。</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;Received C-c - shutting down&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>And when we run it, instead of seeing the default message Go provides when it receives an interrupt signal, we can see our own message:</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">03</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">214602.313917282</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">214605.313950300</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">214608.313950904</span>
<span class="pun">^</span><span class="typ">CReceived</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
</pre>

<p>Excellent, so let’s start moving the program closer to what we want - running multiple goroutines and stopping them cleanly</p>

<p>非常好，我们将程序改成更接近我们想要的–运行多协程并干净的结束他们</p>

<h2>Signalling a Goroutine to Stop 发送信号让协程停止</h2>

<p>Even though we only have one task at the moment, we will put it into it’s own goroutine and signal it to stop when we have received the C-c. I’m going to use the first half of a post called “Stopping Goroutines” by the excellent Mat Ryer as the basis for this process. Note when this post was written - 2015 - and be sure we’ll change a few things by the time we’ve finished this article.</p>

<p>尽管我们此刻只有一个任务，但我们我们会将他放在他自己的协程中，并且当他接受到C-c信号的时候停止。</p>

<p>The next example shows the ticker in it’s own goroutine. Notice that instead of keeping the signal receiver in the for select case &lt;-c we’ll just change it to &lt;-c since that’s the only thing we’re going to leave in main(). I will prefix the messages with either main or tick so you can see what’s going on.</p>

<p>下一个例子展示了在它自己单独的协程里的ticker。注意，我们将改用&lt;-c, 而不是将信号接受放在for select case &lt;-c中。因为这是我们唯一放在main()中的语句.我将会在消息中加上main或者tick的前缀，让你看到哪一个正在执行。</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// a channel to tell `tick()` to stop, and one to tell us they&#39;ve stopped</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">stoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">stoppedChan</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them to reply back</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stoppedChan</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: goroutine has told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stop</span><span class="pun">,</span> <span class="pln">stopped</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">close</span><span class="pun">(</span><span class="pln">stopped</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>Once you press C-c here, you can see the exchange of messages.</p>

<p>一旦你按下了C-c，你可以看到消息的交换。</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">04</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220018.345218301</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220021.345202622</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220024.345147172</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">goroutine</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>So far so good. It works.
到现在为止还挺好。它起作用了。</p>

<p>But I can see one problem on the horizon. When we add another goroutine, we’ll have to create another stopped channel for the second goroutine to tell us when they’ve stopped. (Side-note: I originally also created a new stop chan too, but we can re-use that channel for both goroutines.)</p>

<p>但是我预见了一个问题。当我添加另外一个协程时，我们将为第二个协程创建另外一个stoped channel用于告诉我们协程何时停止。（边注：我原来也创建了一个新的stop channel，但是我们可以重新使用该channel用于这两个goroutine）</p>

<p>Let’s see what the extra stopped channel looks like. In this example our second goroutine tock() is very similar to the first, except it tocks every 5s instead of ticks every 3s.</p>

<p>让我们看看额外的stopped channel。在这个例子中，我们的第二个goroutine tock()和第一个非常相似，不同点是第二个是每隔5s而第一个是每隔3s。</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// a channel to tell `tick()` and `tock()` to stop</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>

    <span class="com">// a channel for `tick()` to tell us they&#39;ve stopped</span>
    <span class="pln">tickStoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">tickStoppedChan</span><span class="pun">)</span>

    <span class="com">// a channel for `tock()` to tell us they&#39;ve stopped</span>
    <span class="pln">tockStoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">tockStoppedChan</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them to reply back</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">tickStoppedChan</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">tockStoppedChan</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stop</span><span class="pun">,</span> <span class="pln">stopped</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">close</span><span class="pun">(</span><span class="pln">stopped</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stop</span><span class="pun">,</span> <span class="pln">stopped</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">close</span><span class="pun">(</span><span class="pln">stopped</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tock: tock %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tock: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>It’s starting to look unwieldy. However, let’s take a look at the output for completeness:</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">05</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220618.466725240</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220620.466789888</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220621.466756817</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220624.466762771</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>Even though it’s looking a bit nasty, it still works as it should.</p>

<h2>sync.WaitGroup</h2>

<p>Let’s try and tidy-up and simplify a bit here. The reason to do this is because if we’d like to add another goroutine to this program - or indeed another 10, 20 or a hundred - we’re going to have a headache with all the channels we need to create.</p>

<p>让我们尝试、整理并简化。做这个的理由是因为如果我们想在这个程序中添加其他goroutine - 或者甚至其他10，20，或者100个 - 处理所有我们需要创建的channel会让我们头疼。</p>

<p>So instead of channels, let’s try another concurrency fundamental that Go provides, which is sync.WaitGroup. Here we create just one WaitGroup (instead of two channels) and use that for the goroutines to signal they’ve finished. Remember, once we create the WaitGroup we shouldn’t copy it, so we need to pass it by reference.</p>

<p>所以，除了channel，让我们尝试另外的Go提供的并发基本原则–sync.WaitGroup.在这里，我们仅仅创建一个WaitGroup(而不是两个channel)，用于当协程结束时发送信息。记住，一旦我们创建了WaitGroup，我们不能拷贝它，我们需要通过引用(指针？？？)传递。</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;sync&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// a channel to tell `tick()` and `tock()` to stop</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>

    <span class="com">// a WaitGroup for the goroutines to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">{</span><span class="pun">}</span>

    <span class="com">// a channel for `tick()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// a channel for `tock()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them both to reply back</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Wait</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stop</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stop</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tock: tock %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tock: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

</pre>

<p>The output is exactly the same as the previous program, so we should be on the right lines. The program itself has a few lines removed, a few lines added and looks very similar, however adding new goroutines is a little simpler now. We just need call wg.Add(1) and pass both the stop channel and the waitgroup to it. As I said, it’s only a little simpler but that’s good, right?</p>

<p>输出完全和之前程序一样，所以我们应该在正确的行上。这个程序本身有些行删除了，一些行添加了，看起来差不多，但是添加新的goroutine比之前简单了。我们仅仅需要调用wg.Add(1)，传递stop通道和waitgroup给它。正如我所说的，仅仅简单一点点，但是很不错，对吧？！</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">06</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221717.992723221</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221719.992700713</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221720.992722592</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221723.992745407</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>So far, so good. However, there is another problem on the horizon. Let’s imagine we want to also create a webserver in a goroutine. In the past we used to create one using the following code. The problem here though is that the server blocks the goroutine until it has finished.</p>

<p>到现在为止，都很好，但是，又有一个新的问题。让我们想象一下我们也想在goroutine中创建web服务器。过去我们常常使用以下的代码创建协程。而现在的问题是server直到它结束前，一直阻塞着协程。</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;net/http&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">http</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Fprintln</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Hello, World!&#34;</span><span class="pun">)</span>
    <span class="pun">}</span><span class="pun">)</span>
    <span class="pln">http</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="str">&#34;:8080&#34;</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>So the question is, how do we also tell the web server to stop?
所以问题是，我们应该怎样告诉web服务器去停止运行。</p>

<h2>Context</h2>

<p>In Go v1.7, the context package was added and that is our next secret. The ability to tell a webserver to stop using a context was also added. Using a Context has become the swiss-army knife of concurrency control in Go over the past few years (it used to live at <a href="https://godoc.org/golang.org/x/net/context">https://godoc.org/golang.org/x/net/context</a> but was moved into the standard library).</p>

<p>在Go的1.7版本加入了context包，这就是我们下一个秘密武器。使用context来停止webservver的运行的能力同样也具有。在Go的过去的几年中，使用Context变成并发控制的瑞士军刀。（它以前在 <a href="https://godoc.org/golang.org/x/net/context,但是现在已经移入标准库了）">https://godoc.org/golang.org/x/net/context,但是现在已经移入标准库了）</a></p>

<p>Let’s have a very quick look at how we can create and cancel a Context:
让我们快速地了解一下如何创建和取消上下文:</p>

<pre>    <span class="com">// create a context that we can cancel</span>
    <span class="pln">ctx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithCancel</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// pass this ctx to our goroutines - each of which would select on `&lt;-ctx.Done()`</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">.</span><span class="pun">.</span><span class="pun">.</span><span class="pun">)</span>

    <span class="com">// sometime later ... in our case after a `C-c`</span>
    <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>
</pre>

<p>(Side note: if you haven’t see JustForFunc by Francesc Campoy yet, you should watch it - Francesc talks about the Context package in episodes 9 and 10.)</p>

<p>One major advantage of using a Context over a stop channel is if any of the goroutines are also creating other goroutines to do the work for them. In the case of using stopped channels we’d have to create more stop channels to tell the child goroutines to finish. We’d also have to tie much of this together to make it work. When we use a Context however, each goroutine would derive a Context from the one it was given, and each of them would be told to cancel.</p>

<p>使用Context比使用stop channel最主要的优势是，协程是否也创建其他协程来工作。因为使用stopped channels，我们不得不创建更多的stop channe，来让子协程终止。我们同样不得不将这些整合起来来让它起作用。但是当我们使用Context，每一个协程都会继承传递给它的Context，并且每一个(继承者)都被告之要删除。</p>

<p>Before we try adding a webserver, let’s change our example above to use a Context. The first thing we’ll need to do is pass the context to each goroutine instead of the channel. Instead of selecting on the channel, it’ll select on &lt;-ctx.Done() and still signal back to main() when it has tidied up.</p>

<p>在我们尝试添加一个webserver之前,让我们修改我们上面使用Context例子。我要做的第一个事情就是将传递channel改为传递Context给每一个goroutine，将监听channel改为监听ctx.Done()，并且仍发送信号，当整理（tidy up）好协程之后返回main()</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;context&#34;</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;sync&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// create a context that we can cancel</span>
    <span class="pln">ctx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithCancel</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// a WaitGroup for the goroutines to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">{</span><span class="pun">}</span>

    <span class="com">// a channel for `tick()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// a channel for `tock()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutines to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// and wait for them both to reply back</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Wait</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ctx</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tock: tock %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ctx</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tock: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>There is very little difference between this program and the previous one, however we now have the ability to:</p>

<p>这个程序与之前的有点不一样，我们现在有能力来：</p>

<ol>
<li><p>create a webserver that we can cancel with the Context
创建一个能使用Context取消的webserver</p></li>

<li><p>pass the same context to sub goroutines which will also cancel their work when told
And again, the output is the same. We must be doing something right.</p></li>
</ol>

<p>传递相同的context到子协程，并取消协程。输出结果又一次相同。我们做对了。</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">07</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">223954.341894561</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">223956.341886006</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">223957.341887182</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">224000.341927373</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>Now let’s get onto the beast and tell our program to also serve HTTP requests.</p>

<p>现在要实现我们的野望了。让我们的程序同样提供HTTP请求</p>

<h2>The Webserver</h2>

<p>Before we show the entire program, let’s take a look at what the webserver goroutine would look like. The magic here is that instead of calling http.ListenAndServe() we explicitly create the webserver and by doing this we can eventually signal to it to stop. We’re going to model this on the excellent HTTP server connection draining section of this article by Tyler Christensen.</p>

<p>在我们展示全部程序之前，让我们看一下webserver的协程是什么样的。这里神奇的地方是，不是调用 http.ListenAndServe()而是明确的创建webserver并且通过这样做，我们能最终使用信号终止它。我们将要在这优秀的HTTP服务连接上构建这个方法</p>

<pre><span class="kwd">func</span> <span class="pln">server</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller that we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// create a new mux and handler</span>
    <span class="pln">mux</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewServeMux</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">mux</span><span class="pun">.</span><span class="typ">Handle</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span><span class="pun">(</span><span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: received request&#34;</span><span class="pun">)</span>
        <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
        <span class="pln">io</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Finished!\n&#34;</span><span class="pun">)</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: request finished&#34;</span><span class="pun">)</span>
    <span class="pun">}</span><span class="pun">)</span><span class="pun">)</span>

    <span class="com">// create a server</span>
    <span class="pln">srv</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Server</span><span class="pun">{</span><span class="typ">Addr</span><span class="pun">:</span> <span class="str">&#34;:8080&#34;</span><span class="pun">,</span> <span class="typ">Handler</span><span class="pun">:</span> <span class="pln">mux</span><span class="pun">}</span>

    <span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="com">// service connections</span>
        <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">srv</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Listen : %s\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ctx</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: caller has told us to stop&#34;</span><span class="pun">)</span>

    <span class="com">// shut down gracefully, but wait no longer than 5 seconds before halting</span>
    <span class="pln">shutdownCtx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithTimeout</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">5</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// ignore error since it will be &#34;Err shutting down server : context canceled&#34;</span>
    <span class="pln">srv</span><span class="pun">.</span><span class="typ">Shutdown</span><span class="pun">(</span><span class="pln">shutdownCtx</span><span class="pun">)</span>

    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server gracefully stopped&#34;</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>For this func, the only two lines we added in main() were:</p>

<p>对于这个函数来说，只需main()添加两行就行了。</p>

<pre>    <span class="com">// run `server` in it&#39;s own goroutine</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">server</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>
</pre>

<p>For the output of this program, I will send a request to the server curl localhost:8080 after the first tick and you should see the request start and finish either side of the 2nd tick. And as usual we’ll just show three ticks (and one tock):</p>

<p>输出程序的结果，我将在第一个tick后面向服务器发送请求，你应该看到请求在开始和结束在第二个tick的两边。和通常的一样，我们仅展示3个tick（和一个tock）</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">08</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230003.228960866</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">received</span> <span class="pln">request</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230005.228893119</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230006.228868513</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">request</span> <span class="pln">finished</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230009.228863351</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">server</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">server</span> <span class="pln">gracefully</span> <span class="pln">stopped</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>And as we expected the server also shut down correctly. This time though, I’ll send a request after the 2nd tick but C-c the server before the 3rd tick to demonstrate the server graefully shutting down.</p>

<p>和我们预期的一样，正确的退出了。这一次，我们在第二个tick后发出请求，但是在第三个tick前发送C-c，以此来证明服务器安全退出了。</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">08</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230408.026717601</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230410.026710464</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230411.026700385</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">received</span> <span class="pln">request</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">server</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="typ">Listen</span> <span class="pun">:</span> <span class="pln">http</span><span class="pun">:</span> <span class="typ">Server</span> <span class="pln">closed</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">request</span> <span class="pln">finished</span>
<span class="pln">server</span> <span class="pln">gracefully</span> <span class="pln">stopped</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>Notice that both tick() and tock() finished first, then we had a couple of seconds where we waited for the webserver to finish it’s request and then finally shut down. In the previous example the server shut down when it wasn’t servicing any requests and the srv.ListenAndServe() didn’t return any error. In this example the server was servicing a request and returned the http: Server closed error which appeared above - after which the request finished message appeared to prove the request was still in progress. However, it did finish, the client received the response and everything shut down as expected.、</p>

<p>注意：tick()和tock()先结束，然后我们我们等待了一会服务器完成请求之后，最终退出了。之前的例子，当服务器没有处理任何请求的时候，且 the srv.ListenAndServe()没有返回任何错误，服务器（立即）退出。在这个例子中，服务器处理请求并返回了上面出现的http: Server closed错误 –  请求完成之后，出现的“request finished”信息证明了请求仍然在执行。但是，它的确结束了，客户端收到了响应，一切都像期望的那样结束。</p>

<pre><span class="pun">$</span> <span class="pln">curl</span> <span class="pln">localhost</span><span class="pun">:</span><span class="dec">8080</span>
<span class="typ">Finished</span><span class="pun">!</span>
</pre>

<p>And that’s it! I hope you’ve enjoyed following along in this rather long article, but I hope we demonstrated not just how to use a Context to cancel multiple goroutines, but also how the way we write concurrent Go programs has changed over the years. As with everything, there are many ways to do all of this and I’m sure I’ve missed some but I hope that has given you a taster to play with more concurrency and Context.</p>

<h1>我的读（翻译？）后感</h1>

<p>使用stopped channel等待所有的协程结束</p>

<pre><span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">count</span><span class="pun">;</span> <span class="pln">i</span><span class="pun">+</span><span class="pun">+</span><span class="pun">{</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stoppedChan</span>
<span class="pun">}</span> 
</pre>

<p>来等待所有的协程结束。具体的代码如下</p>

<pre>    <span class="com">// a channel to tell `tick()` and `tock()` to stop</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">stoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">count</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span>

    <span class="pln">count</span><span class="pun">+</span><span class="pun">+</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">stoppedChan</span><span class="pun">)</span>

    <span class="pln">count</span><span class="pun">+</span><span class="pun">+</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">stoppedChan</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them both to reply back</span>

    <span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">count</span><span class="pun">;</span> <span class="pln">i</span><span class="pun">+</span><span class="pun">+</span><span class="pun">{</span>
        <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stoppedChan</span>
    <span class="pun">}</span> 
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
</pre>

<p>确定很明显，子协程仍需要像父线程一样，创建stop channel，麻烦不止一点点。。</p>

<p>我的翻译真是一坨屎。。。。</p>

<p>context.Backgroud()是一个非nil空Context。没有值，没有deadline。经常用于main函数初始化，测试，作为请求的最高等级的Context。</p>

<p>server中的shutdownCtx, cancel := context.WithTimeout(context.Background(), 5*time.Second)的第一个返回值就是新的带时间截止控制的context。第二个返回值是执行时间到达的时，执行的函数。例如这样：</p>

<pre>    <span class="pln">shutdownCtx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithTimeout</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">5</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">cancel</span> <span class="pun">=</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;斩斩斩&#34;</span><span class="pun">)</span>
    <span class="pun">}</span>
</pre>

<p>主动创建服务器的过程</p>

<pre>    <span class="pln">mux</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewServeMux</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">mux</span><span class="pun">.</span><span class="typ">Handle</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span><span class="pun">(</span><span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: received request&#34;</span><span class="pun">)</span>
        <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
        <span class="pln">io</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Finished!\n&#34;</span><span class="pun">)</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: request finished&#34;</span><span class="pun">)</span>
    <span class="pun">}</span><span class="pun">)</span><span class="pun">)</span>

    <span class="pln">srv</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Server</span><span class="pun">{</span><span class="typ">Addr</span><span class="pun">:</span> <span class="str">&#34;:8080&#34;</span><span class="pun">,</span> <span class="typ">Handler</span><span class="pun">:</span> <span class="pln">mux</span><span class="pun">}</span>

    <span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="com">// service connections</span>
        <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">srv</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Listen : %s\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>

</pre>

<p>服务器关闭</p>

<pre>    <span class="pln">srv</span><span class="pun">.</span><span class="typ">Shutdown</span><span class="pun">(</span><span class="pln">shutdownCtx</span><span class="pun">)</span>
</pre>

<p>注意，此Shutdown方法，只有go的版本大于等于1.8的才有。</p>
</div>
</body>

</html>