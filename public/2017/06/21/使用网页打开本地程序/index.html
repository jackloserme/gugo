<html>

<head>
    <title>使用网页打开本地程序</title>
</head>

<body>
    <div>使用网页打开本地程序</div>
    <div>2017-06-21 20:44:40</div>
    <div><p>浏览器中使用window.open()打开URL。当URL为特定的前缀的时候（URI Scheme），就会调用注册表中对应的指令。</p>

<h2>写入注册表</h2>

<p>参考 <a href="https://msdn.microsoft.com/en-us/library/aa767914(VS.85).aspx">https://msdn.microsoft.com/en-us/library/aa767914(VS.85).aspx</a>
其中的关键是在注册表中写入如下的注册表项</p>

<pre><code>HKEY_CLASSES_ROOT
   alert
      (Default) = &#34;URL:Alert Protocol&#34;
      URL Protocol = &#34;&#34;
      DefaultIcon
         (Default) = &#34;alert.exe,1&#34;
      shell
         open
            command
               (Default) = &#34;C:\Program Files\Alert\alert.exe&#34; &#34;%1
</code></pre>

<p>使用go操作注册表.path为程序的地址。uri为调用程序的URI Scheme。
使用js调用window.open(“uri://“)就可以打开程序。</p>

<pre><span class="kwd">func</span> <span class="pln">regKey</span><span class="pun">(</span><span class="pln">path</span> <span class="pln">string</span><span class="pun">,</span><span class="pln">uri</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
    <span class="pln">vconsoleKey</span><span class="pun">,</span> <span class="pln">ok</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">registry</span><span class="pun">.</span><span class="typ">CLASSES_ROOT</span><span class="pun">,</span> <span class="pln">uri</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">|</span><span class="pln">registry</span><span class="pun">.</span><span class="typ">SET_VALUE</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey console err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">ok</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="pln">defer</span> <span class="pln">vconsoleKey</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">vconsoleKey</span><span class="pun">.</span><span class="typ">SetStringValue</span><span class="pun">(</span><span class="str">&#34;URL Protocol&#34;</span><span class="pun">,</span> <span class="str">&#34;&#34;</span><span class="pun">)</span>
    <span class="pln">vconsoleKey</span><span class="pun">.</span><span class="typ">SetStringValue</span><span class="pun">(</span><span class="str">&#34;DefaultIcon&#34;</span><span class="pun">,</span> <span class="pln">path</span><span class="pun">)</span>
    <span class="pln">shellKey</span><span class="pun">,</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">vconsoleKey</span><span class="pun">,</span> <span class="str">`shell`</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey shell err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="pln">openKey</span><span class="pun">,</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">shellKey</span><span class="pun">,</span> <span class="str">`open`</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey open err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="pln">commandKey</span><span class="pun">,</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">openKey</span><span class="pun">,</span> <span class="str">`command`</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">|</span><span class="pln">registry</span><span class="pun">.</span><span class="typ">SET_VALUE</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="pln">commandKey</span><span class="pun">.</span><span class="typ">SetStringValue</span><span class="pun">(</span><span class="str">&#34;&#34;</span><span class="pun">,</span> <span class="pln">path</span><span class="pun">)</span>

    <span class="kwd">return</span> <span class="kwd">nil</span>
<span class="pun">}</span>
</pre>

<h2>获取管理员权限</h2>

<p>在注册表中写入注册表项需要管理员权限。
- go get github.com/akavel/rsrc
- 把nac.manifest文件拷贝到当前windows项目根目录
- rsrc -manifest nac.manifest -o nac.syso
- go build</p>

<p>nac.mainfest的内容为：</p>

<pre><span class="pun">&lt;</span><span class="pun">?</span><span class="pln">xml</span> <span class="pln">version</span><span class="pun">=</span><span class="str">&#34;1.0&#34;</span> <span class="pln">encoding</span><span class="pun">=</span><span class="str">&#34;UTF-8&#34;</span> <span class="pln">standalone</span><span class="pun">=</span><span class="str">&#34;yes&#34;</span><span class="pun">?</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">assembly</span> <span class="pln">xmlns</span><span class="pun">=</span><span class="str">&#34;urn:schemas-microsoft-com:asm.v1&#34;</span> <span class="pln">manifestVersion</span><span class="pun">=</span><span class="str">&#34;1.0&#34;</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">trustInfo</span> <span class="pln">xmlns</span><span class="pun">=</span><span class="str">&#34;urn:schemas-microsoft-com:asm.v3&#34;</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">security</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">requestedPrivileges</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">requestedExecutionLevel</span> <span class="pln">level</span><span class="pun">=</span><span class="str">&#34;requireAdministrator&#34;</span><span class="pun">/</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">requestedPrivileges</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">security</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">trustInfo</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">assembly</span><span class="pun">&gt;</span>
<span class="str">``</span><span class="str">`ivileges&gt;
&lt;requestedExecutionLevel level=&#34;requireAdministrator&#34;/&gt;
&lt;/requestedPrivileges&gt;
&lt;/security&gt;
&lt;/trustInfo&gt;
&lt;/assembly&gt;
</span></pre>
</div>
</body>

</html>