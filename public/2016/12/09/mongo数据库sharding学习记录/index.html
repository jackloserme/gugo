<html>

<head>
    <title>mongo数据库sharding学习记录</title>
</head>

<body>
    <div>mongo数据库sharding学习记录</div>
    <div>2016-12-09 16:36:40</div>
    <div><p>参考文章：<a href="http://www.runoob.com/mongodb/mongodb-sharding.html">http://www.runoob.com/mongodb/mongodb-sharding.html</a></p>

<p>windows系统。mongo3.2版本</p>

<p>建立目录s0,s1,log,config</p>

<p>步骤一：启动Shard Server</p>

<pre><code>.\bin\mongod.exe --port 27100 --dbpath=.\mongos\s0 --logpath=.\mongos\log\s0.log --logappend --journal --storageEngine=mmapv1 --shardsvr

.\bin\mongod.exe --port 27101 --dbpath=.\mongos\s1 --logpath=.\mongos\log\s1.log --logappend --journal --storageEngine=mmapv1 --shardsvr
</code></pre>

<p>步骤二： 启动Config Server</p>

<pre><code>.\bin\mongod.exe --port 27200 --dbpath=.\mongos\config --logpath=.\mongos\log\config.log --logappend --journal --storageEngine=mmapv1 --configsvr
</code></pre>

<p>步骤三： 启动Route Process</p>

<pre><code>.\bin\mongos.exe --port 40000 --configdb localhost:27200  --logpath=.\mongos\log\router.log --chunkSize 1
</code></pre>

<p>注意:
1. 我这里不加–configsvr就出现Surprised to discover that localhost:27200 does not believe it is a config server错误。
2. chunkSize太大的话，会导致插入很多很多数据后才分片。一开始没注意，以为设置错误没有分片。。。chunkSize以M为单位。</p>

<p>步骤四： 配置Sharding</p>

<ul>
<li><p>连接路由服务器</p>

<pre><code>.\bin\mongo.exe admin --port 40000
</code></pre></li>

<li><p>设置分片服务器</p>

<pre><code>db.runCommand({ addshard:&#34;127.0.0.1:27100&#34; })
db.runCommand({ addshard:&#34;127.0.0.1:27101&#34; })
db.runCommand({ addshard:&#34;127.0.0.1:40000&#34; })
或者
sh.addShard(&#34;127.0.0.1:27100&#34;)
</code></pre></li>

<li><p>设置要分片的数据库</p>

<pre><code>db.runCommand({ enablesharding:&#34;qdgame&#34; })
或者：
sh.enableSharding(&#34;qdgame&#34;)
</code></pre></li>

<li><p>关闭balancing</p>

<pre><code>sh.disableBalancing(&#34;qdgame.backpack&#34;)
</code></pre></li>

<li><p>设置分片collection的index</p>

<pre><code>use qdgame
db.backpack.ensureIndex({usrid:1,id:1})
</code></pre></li>

<li><p>设置要分片的collection</p>

<pre><code>db.runCommand({ shardcollection: &#34;qdgame.backpack&#34;, key: { usrid:1, id:1}})
或者
sh.shardCollection(&#34;qdgame.backpack&#34;,{usrid:1, id:1})
</code></pre></li>

<li><p>开启balancing</p>

<pre><code>sh.enableBalancing(&#34;qdgame.backpack&#34;)
</code></pre></li>
</ul>

<p>注意：设置一定要在admin数据库下。
e.backpack”,{usrid:1, id:1})</p>

<pre><code>
- 开启balancing
</code></pre>

<p>sh.enableBalancing(“qdgame.backpack”)
```</p>

<p>注意：设置一定要在admin数据库下。</p>
</div>
</body>

</html>